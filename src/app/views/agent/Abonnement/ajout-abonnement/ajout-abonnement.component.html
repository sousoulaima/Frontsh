<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ajouter un Abonnement</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      margin: 0;
      padding: 0;
    }

    .ajout-abonnement-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #f0f0f0;
    }

    .ajout-abonnement {
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 90%;
      max-width: 1200px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(90deg, #1e3a8a, #3b82f6);
      padding: 15px 20px;
      border-bottom: 1px solid #ccc;
    }

    .header-title {
      display: flex;
      align-items: center;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }

    .green {
      background-color: #28a745;
    }

    .status-text {
      font-size: 12px;
      margin-right: 10px;
    }

    .text-blue-800 {
      color: #1e3a8a;
      font-size: 24px;
      font-weight: 700;
    }

    .header-date {
      font-size: 12px;
    }

    .window-controls {
      display: flex;
      gap: 5px;
    }

    .window-controls span {
      cursor: pointer;
      font-size: 14px;
      padding: 2px 5px;
    }

    .form-container {
      padding: 10px;
    }

    .section {
      margin-bottom: 10px;
    }

    .section-title {
      display: block;
      font-weight: bold;
      color: #1e3a8a;
      margin-bottom: 5px;
      background-color: #e0e0e0;
      padding: 5px;
      border-radius: 3px;
    }

    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 5px;
    }

    .form-group {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .form-input {
      width: 100%;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 12px;
    }

    .form-input[readonly] {
      background-color: #f0f0f0;
    }

    .action-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
      background-color: #1e3a8a;
      color: #fff;
    }

    .action-btn.pointer {
      background-color: #dc3545;
    }

    .add-btn {
      background-color: #28a745;
    }

    .delete-btn {
      background-color: #dc3545;
    }

    .table-container {
      margin-bottom: 10px;
    }

    .abonnement-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .abonnement-table th,
    .abonnement-table td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
    }

    .abonnement-table th {
      background-color: #1e3a8a;
      color: #fff;
    }

    .abonnement-table tbody tr:nth-child(even) {
      background-color: #f0f0f0;
    }

    .actions-row {
      justify-content: space-between;
      align-items: center;
    }

    .paid-amount {
      background-color: #28a745;
      color: #fff;
    }

    .remaining-amount {
      background-color: #dc3545;
      color: #fff;
    }

    .save-btn {
      padding: 8px 16px;
      background-color: #1e3a8a;
      color: #fff;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: background-color 0.3s;
    }

    .save-btn:hover {
      background-color: #16307a;
    }

    .cancel-btn {
      padding: 8px 16px;
      background-color: #6b7280;
      color: #fff;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: background-color 0.3s;
    }

    .cancel-btn:hover {
      background-color: #4b5563;
    }

    .print-btn {
      padding: 5px 10px;
      background-color: #1e3a8a;
      color: #fff;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
    }

    .modal.show {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 5px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: bold;
      color: #1e3a8a;
    }

    .close-btn {
      cursor: pointer;
      font-size: 24px;
      color: #6b7280;
    }

    .error {
      color: #dc3545;
      font-size: 12px;
      margin-top: 2px;
    }

    .windows-activation,
    .settings-link,
    .escape-text {
      font-size: 12px;
      color: #1e3a8a;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="ajout-abonnement-container">
    <div class="ajout-abonnement">
      <div class="header">
        <div class="header-title text-center w-full">
          <h1 class="text-white text-2xl font-bold animate-fade-in border-b-2 border-blue-200 pb-1">Ajouter un Abonnement</h1>
        </div>
      </div>

      <form (ngSubmit)="saveAbonnement()" #abonnementForm="ngForm" class="form-container">
        <!-- Sélection Adhérent -->
        <div class="form-group">
          <label>Adhérent</label>
          <div class="flex items-center gap-2">
            <select
              [(ngModel)]="newAbonnement.adherent_code"
              name="adherent_code"
              required
              #adherent_code="ngModel"
              class="form-input flex-1"
            >
              <option value="" disabled>Sélectionner un adhérent</option>
              <option *ngFor="let adherent of adherents" [value]="adherent.code">
                {{ adherent.nom }} {{ adherent.prenom }} ({{ adherent.code }})
              </option>
            </select>
            <button
              type="button"
              class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center hover:bg-blue-600 transition"
              (click)="openAddAdherentModal()"
            >
              +
            </button>
          </div>
          <span class="error" *ngIf="adherent_code.invalid && adherent_code.touched">L'adhérent est requis</span>
        </div>

      

        <!-- Catégorie -->
        <div class="form-group">
          <label>Catégorie</label>
          <select [(ngModel)]="newAbonnement.categorie_abonnement_codecateg" 
                  name="categorie_abonnement_codecateg"
                  required
                  class="form-input"
                  (change)="onCategorieChange()">
            <option value="">Sélectionner une catégorie</option>
            <option *ngFor="let categorie of categories" 
                    [value]="categorie.codecateg">
              {{ categorie.designationcateg }}
            </option>
          </select>
        </div>

  <!-- Sélection Type Abonnement -->
  <div class="form-group">
    <label>Type d'Abonnement</label>
    <select
      [(ngModel)]="newAbonnement.type_abonnement_code"
      name="type_abonnement_code"
      required
      #type_abonnement_code="ngModel"
      class="form-input"
      (change)="onTypeChange()"
    >
      <option value="" disabled>Sélectionner un type</option>
      <option *ngFor="let type of typesAbonnement2" [value]="type.code">
        {{ type.designation }} ({{ type.forfait }} DT)
      </option>
    </select>
    <span class="error" *ngIf="type_abonnement_code.invalid && type_abonnement_code.touched">Le type est requis</span>
  </div>

        <!-- Dates -->
        <div class="form-row">
          <div class="form-group">
            <label>Date de Début</label>
            <input
              type="date"
              [(ngModel)]="newAbonnement.datedeb"
              name="datedeb"
              required
              #datedeb="ngModel"
              class="form-input"
              (change)="onTypeChange()"
            />
          </div>
          
          <div class="form-group">
            <label>Date de Fin</label>
            <input
              type="date"
              [(ngModel)]="newAbonnement.datefin"
              name="datefin"
              class="form-input"
              [min]="newAbonnement.datedeb"
              readonly
            />
          </div>
        </div>

        <!-- Informations financières -->
        <div class="form-row">
          <div class="form-group">
            <label>Remise (DT)</label>
            <input
              type="number"
              [(ngModel)]="newAbonnement.totalremise"
              name="totalremise"
              min="0"
              step="0.01"
              #totalremise="ngModel"
              class="form-input"
              (input)="updateFinancials()"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Total TTC (DT)</label>
            <input
              type="number"
              [(ngModel)]="newAbonnement.totalttc"
              name="totalttc"
              class="form-input"
              readonly
            />
          </div>
          
          <div class="form-group">
            <label>Montant Payé (DT)</label>
            <input
              type="number"
              [(ngModel)]="newAbonnement.mtpaye"
              name="mtpaye"
              required
              min="0"
              step="0.01"
              #mtpaye="ngModel"
              class="form-input"
              (input)="updateSolde()"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Reste à Payer (DT)</label>
            <input
              type="number"
              [(ngModel)]="newAbonnement.restepaye"
              name="restepaye"
              class="form-input"
              readonly
            />
          </div>
          
          <div class="form-group">
            <label>Mode de Paiement</label>
        
            <select
            [(ngModel)]="newAbonnement.modalite_reg_id"
            name="modalite_reg_id"
            required
            #modalite_reg_id="ngModel"
            class="form-input"
          
          >
              <option value="" disabled>Sélectionner un mode</option>
              <option *ngFor="let method of filteredModalites" [value]="method.codeMod">{{ method.designationmod }}</option>
            </select>
          </div>
        </div>

        <div class="form-actions flex justify-end space-x-4 mt-4">
          <button type="button" class="cancel-btn" (click)="goBack()">Retour</button>
          <button type="submit" class="save-btn" [disabled]="!abonnementForm.valid">Enregistrer</button>
        </div>
      </form>

      <!-- Modal for adding new adherent -->
      <div class="modal" [ngClass]="{'show': showAddAdherentModal}">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">Ajouter un nouvel adhérent</h2>
            <span class="close-btn" (click)="closeAddAdherentModal()">×</span>
          </div>
          <form (ngSubmit)="saveAdherent()" #adherentForm="ngForm">
            <div class="form-group">
              <label>Nom</label>
              <input
                type="text"
                [(ngModel)]="newAdherent.nom"
                name="nom"
                required
                #nom="ngModel"
                class="form-input"
              />
              <span class="error" *ngIf="nom.invalid && nom.touched">Le nom est requis</span>
            </div>
            <div class="form-group">
              <label>Prénom</label>
              <input
                type="text"
                [(ngModel)]="newAdherent.prenom"
                name="prenom"
                required
                #prenom="ngModel"
                class="form-input"
              />
              <span class="error" *ngIf="prenom.invalid && prenom.touched">Le prénom est requis</span>
            </div>
            <div class="form-group">
              <label>Email</label>
              <input
                type="email"
                [(ngModel)]="newAdherent.email"
                name="email"
                class="form-input"
              />
            </div>
            <div class="form-group">
              <label>Adresse</label>
              <input
                type="text"
                [(ngModel)]="newAdherent.adresse"
                name="adresse"
                class="form-input"
              />
            </div>
            <div class="form-group">
              <label>Téléphone 1</label>
              <input
                type="tel"
                [(ngModel)]="newAdherent.tel1"
                name="tel1"
                class="form-input"
              />
            </div>
            <div class="form-group">
              <label>Téléphone 2</label>
              <input
                type="tel"
                [(ngModel)]="newAdherent.tel2"
                name="tel2"
                class="form-input"
              />
            </div>
            <div class="form-group">
              <label>Profession</label>
              <input
                type="text"
                [(ngModel)]="newAdherent.profession"
                name="profession"
                class="form-input"
              />
            </div>
            <div class="form-group">
              <label>CIN</label>
              <input
                type="text"
                [(ngModel)]="newAdherent.cin"
                name="cin"
                class="form-input"
              />
            </div>
            <div class="form-group">
              <label>Date de naissance</label>
              <input
                type="date"
                [(ngModel)]="newAdherent.datenaissance"
                name="datenaissance"
                class="form-input"
              />
            </div>
            <div class="form-group">
              <label>Code TVA</label>
              <input
                type="text"
                [(ngModel)]="newAdherent.codetva"
                name="codetva"
                class="form-input"
              />
            </div>
            <div class="form-group">
              <label>Raison sociale</label>
              <input
                type="text"
                [(ngModel)]="newAdherent.raisonsoc"
                name="raisonsoc"
                class="form-input"
              />
            </div>
            <div class="form-group">
              <label>ID pointage</label>
              <input
                type="text"
                [(ngModel)]="newAdherent.idpointage"
                name="idpointage"
                class="form-input"
              />
            </div>
            <div class="form-group">
              <label>Code société</label>
              <input
                type="text"
                [(ngModel)]="newAdherent.societe_code"
                name="societe_code"
                class="form-input"
              />
            </div>
            <div class="form-actions flex justify-end space-x-4 mt-4">
              <button type="button" class="cancel-btn" (click)="closeAddAdherentModal()">Annuler</button>
              <button type="submit" class="save-btn" [disabled]="!adherentForm.valid">Enregistrer</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</body>
</html>