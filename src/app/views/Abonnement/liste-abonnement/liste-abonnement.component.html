<div class="gestion-abonnements-container">
  <div class="gestion-abonnements">
    <!-- Modal for Editing an Abonnement -->
    <div class="modal" *ngIf="showModal" @modalAnimation>
      <div class="modal-content">
        <h2 class="modal-title">{{ isEditing ? '√âditer' : 'Ajouter' }} l'abonnement</h2>
        <form (ngSubmit)="saveAbonnement()" #abonnementForm="ngForm">
          <div class="form-group" *ngIf="isEditing">
            <label>Code</label>
            <input
              type="text"
              [(ngModel)]="currentAbonnement.codeabo"
              name="codeabo"
              required
              readonly
              class="form-input"
            />
          </div>
          
          <div class="form-group">
            <label>Date d'Abonnement</label>
            <input
              type="date"
              [(ngModel)]="currentAbonnement.dateabo"
              name="dateabo"
              required
              class="form-input"
            />
          </div>
          
          <div class="form-group">
            <label>Adh√©rent</label>
            <select
              [(ngModel)]="currentAbonnement.adherent_code"
              name="adherent_code"
              required
              class="form-input"
            >
              <option value="">S√©lectionner un adh√©rent</option>
              <option *ngFor="let adherent of adherents" [value]="adherent.code">
                {{ adherent.nom }} {{ adherent.prenom }}
              </option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Type d'Abonnement</label>
            <select
              [(ngModel)]="currentAbonnement.type_abonnement_code"
              name="type_abonnement_code"
              required
              class="form-input"
              (change)="updateDateFin()"
            >
              <option value="">S√©lectionner un type</option>
              <option *ngFor="let type of typesAbonnement" [value]="type.code">
                {{ type.designation }}
              </option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Date D√©but</label>
            <input
              type="date"
              [(ngModel)]="currentAbonnement.datedeb"
              name="datedeb"
              required
              class="form-input"
              (change)="updateDateFin()"
            />
          </div>
          
          <div class="form-group">
            <label>Date Fin</label>
            <input
              type="date"
              [(ngModel)]="currentAbonnement.datefin"
              name="datefin"
              required
              readonly
              class="form-input"
            />
          </div>
          
          <div class="form-group">
            <label>Total HT (DT)</label>
            <input
              type="number"
              [(ngModel)]="currentAbonnement.totalhtabo"
              name="totalhtabo"
              required
              min="0"
              step="0.01"
              class="form-input"
              (input)="updateFinancials()"
            />
          </div>
          
          <div class="form-group">
            <label>Remise (DT)</label>
            <input
              type="number"
              [(ngModel)]="currentAbonnement.totalremise"
              name="totalremise"
              required
              min="0"
              step="0.01"
              class="form-input"
              (input)="updateFinancials()"
            />
          </div>
          
          <div class="form-group">
            <label>Total HT Net (DT)</label>
            <input
              type="number"
              [(ngModel)]="currentAbonnement.totalht"
              name="totalht"
              required
              min="0"
              step="0.01"
              readonly
              class="form-input"
            />
          </div>
          
          <div class="form-group">
            <label>Total TTC (DT)</label>
            <input
              type="number"
              [(ngModel)]="currentAbonnement.totalttc"
              name="totalttc"
              required
              min="0"
              step="0.01"
              readonly
              class="form-input"
            />
          </div>
          
          <div class="form-group">
            <label>Solde R√©gl√©</label>
            <select
              [(ngModel)]="currentAbonnement.solde"
              name="solde"
              required
              class="form-input"
              (change)="updateFinancials()"
            >
              <option [value]="true">Oui</option>
              <option [value]="false">Non</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Montant Pay√© (DT)</label>
            <input
              type="number"
              [(ngModel)]="currentAbonnement.mtpaye"
              name="mtpaye"
              required
              min="0"
              step="0.01"
              class="form-input"
              (input)="updateFinancials()"
            />
          </div>
          
          <div class="form-group">
            <label>Reste √† Payer (DT)</label>
            <input
              type="number"
              [(ngModel)]="currentAbonnement.restepaye"
              name="restepaye"
              required
              min="0"
              step="0.01"
              readonly
              class="form-input"
            />
          </div>
          
          <div class="form-group">
            <label>Mode de Paiement</label>
            <select
              [(ngModel)]="currentAbonnement.mtpaye"
              name="mtpaye"
              required
              class="form-input"
            >
              <option value="">S√©lectionner un mode</option>
              <option value="Esp√®ces">Esp√®ces</option>
              <option value="Carte">Carte</option>
              <option value="Ch√®que">Ch√®que</option>
            </select>
          </div>
          
          <div class="modal-actions">
            <button type="button" class="cancel-btn" (click)="closeModal()">Annuler</button>
            <button type="submit" class="save-btn" [disabled]="!abonnementForm.valid">Sauvegarder</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal for Viewing an Abonnement -->
    <div class="modal" *ngIf="showViewModal" @modalAnimation>
      <div class="modal-content">
        <h2 class="modal-title">D√©tails de l'abonnement</h2>
        <div class="user-details">
          <p><strong>Code :</strong> {{ viewedAbonnement?.codeabo }}</p>
          <p><strong>Date d'Abonnement :</strong> {{ viewedAbonnement?.dateabo }}</p>
          <p><strong>Adh√©rent :</strong> {{ viewedAbonnement?.adherentName }}</p>
          <p><strong>Type :</strong> {{ viewedAbonnement?.typeDesignation }}</p>
          <p><strong>Date D√©but :</strong> {{ viewedAbonnement?.datedeb }}</p>
          <p><strong>Date Fin :</strong> {{ viewedAbonnement?.datefin }}</p>
          <p><strong>Total HT :</strong> {{ viewedAbonnement?.totalhtabo }} DT</p>
          <p><strong>Remise :</strong> {{ viewedAbonnement?.totalremise }} DT</p>
          <p><strong>Total HT Net :</strong> {{ viewedAbonnement?.totalht }} DT</p>
          <p><strong>Total TTC :</strong> {{ viewedAbonnement?.totalttc }} DT</p>
          <p><strong>Solde R√©gl√© :</strong> {{ viewedAbonnement?.solde ? 'Oui' : 'Non' }}</p>
          <p><strong>Montant Pay√© :</strong> {{ viewedAbonnement?.mtpaye }} DT</p>
          <p><strong>Reste √† Payer :</strong> {{ viewedAbonnement?.restepaye }} DT</p>
          <p><strong>Mode de Paiement :</strong> 
            <span [ngClass]="getMiPayeClass(viewedAbonnement?.mtpaye)">{{ viewedAbonnement?.mtpaye }}</span>
          </p>
        </div>
        <div class="modal-actions">
          <button class="close-btn" (click)="closeViewModal()">Fermer</button>
        </div>
      </div>
    </div>

    <!-- Modal for Delete Confirmation (Removed as Delete button is no longer needed) -->

    <!-- Header Section -->
    <div class="header">
      <div class="header-title">
        <h1 class="text-blue-800">Gestion des Abonnements</h1>
        <p class="text-gray-600">Liste des abonnements enregistr√©s ({{ filteredAbonnements.length }} abonnements)</p>
      </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="search-filter">
      <div class="search">
        <input
          type="text"
          placeholder="Rechercher un abonnement..."
          [(ngModel)]="searchQuery"
          (input)="filterAbonnements()"
          class="search-input"
        />
        <span class="search-icon">üîç</span>
      </div>
      <div class="filter-container">
        <button class="filter-btn" (click)="toggleFilter()">Filtrer ‚ñº</button>
        <div class="filter-dropdown" *ngIf="showFilter" [@filterAnimation]>
          <label class="filter-label">
            Type :
            <select [(ngModel)]="filterType" (change)="filterAbonnements()" class="filter-select">
              <option value="">Tous</option>
              <option *ngFor="let type of typesAbonnement" [value]="type.designation">
                {{ type.designation }}
              </option>
            </select>
          </label>
          <label class="filter-label">
            Mode de Paiement :
            <select [(ngModel)]="filterMiPaye" (change)="filterAbonnements()" class="filter-select">
              <option value="">Tous</option>
              <option value="Esp√®ces">Esp√®ces</option>
              <option value="Carte">Carte</option>
              <option value="Ch√®que">Ch√®que</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <!-- Abonnements Table -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>CODE</th>
            <th>DATE</th>
            <th>ADH√âRENT</th>
            <th>TYPE</th>
            <th>D√âBUT</th>
            <th>FIN</th>
            <th>TOTAL TTC</th>
            <th>PAY√â</th>
            <th>RESTE</th>
            <th>MODE PAIEMENT</th>
            <th>SOLDE</th>
            <th>ACTIONS</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let abonnement of filteredAbonnements">
            <td>{{ abonnement.codeabo }}</td>
            <td>{{ abonnement.dateabo | date:'dd/MM/yy' }}</td>
            <td>{{ abonnement.adherentName }}</td>
            <td>{{ abonnement.typeDesignation }}</td>
            <td>{{ abonnement.datedeb | date:'dd/MM/yy' }}</td>
            <td>{{ abonnement.datefin | date:'dd/MM/yy' }}</td>
            <td>{{ abonnement.totalttc | number:'1.2-2' }} DT</td>
            <td>{{ abonnement.mtpaye | number:'1.2-2' }} DT</td>
            <td>{{ abonnement.restepaye | number:'1.2-2' }} DT</td>
            <td>
              <span class="miPaye" [ngClass]="getMiPayeClass(abonnement.mtpaye)">
                {{ abonnement.mtpaye }}
              </span>
            </td>
            <td>{{ abonnement.solde ? 'Oui' : 'Non' }}</td>
            <td class="actions">
              <button class="action-btn view" (click)="viewAbonnement(abonnement)" title="Voir">üëÅÔ∏è</button>
              <button class="action-btn edit" (click)="openEditAbonnementModal(abonnement)" title="√âditer">‚úèÔ∏è</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>